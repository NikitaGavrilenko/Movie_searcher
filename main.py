from bot_retriever import retriever
from llm_bot import chain, chain_keys, format_docs
from dotenv import load_dotenv
import telebot
import os

# –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–∏
load_dotenv()
TOKEN = os.getenv('TOKEN')
bot = telebot.TeleBot(TOKEN)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start
@bot.message_handler(commands=['start'])
def start_message(message):
    bot.send_message(message.chat.id, '''–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç, –ø–æ –ø–æ–¥–±–æ—Ä—É "—Ç–æ–≥–æ —Å–∞–º–æ–≥–æ" —Ñ–∏–ª—å–º–∞ –Ω–∞ –≤–µ—á–µ—Ä –∏ –≤–æ—Ç —á—Ç–æ —è —É–º–µ—é:

    üé• –ù–∞–π—Ç–∏ —Ñ–∏–ª—å–º –ø–æ –∂–∞–Ω—Ä—É
    ‚Äî –ü–æ–¥–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∞—à–µ–≥–æ –ª—é–±–∏–º–æ–≥–æ –∂–∞–Ω—Ä–∞!
    
    üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    ‚Äî –£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∏ —è –Ω–∞–π–¥—É –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ñ–∏–ª—å–º!
    
    ‚≠ê –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Ñ–∏–ª—å–º
    ‚Äî –•–æ—Ç–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é? –Ø –ø–æ–¥–±–µ—Ä—É —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –¥–ª—è –≤–∞—Å!
    
    üóìÔ∏è –ù–æ–≤–∏–Ω–∫–∏ –∫–∏–Ω–æ
    ‚Äî –£–∑–Ω–∞–π—Ç–µ –æ —Å–∞–º—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–ª–∏–∑–∞—Ö. –≠—Ç–æ—Ç –ø—É–Ω–∫—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–æ–≤–∏–Ω–∫–∞–º–∏!
    
    üìΩÔ∏è –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–ª—å–º—ã
    ‚Äî –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–ª—å–º—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!
    
    ‚ùì –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
    ‚Äî –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –æ —Ñ–∏–ª—å–º–∞—Ö –∏–ª–∏ –∂–∞–Ω—Ä–∞—Ö? –ó–∞–¥–∞–π—Ç–µ –∏—Ö –º–Ω–µ!
    
    ü§ñ –£–∑–Ω–∞—Ç—å –æ –±–æ—Ç–µ
    ‚Äî –£–∑–Ω–∞–π—Ç–µ –±–æ–ª—å—à–µ –æ —Ç–æ–º, —á—Ç–æ —è —É–º–µ—é –∏ –∫–∞–∫ –º–æ–≥—É –ø–æ–º–æ—á—å!

    ''')


@bot.message_handler(content_types=["text"])
def repeat_all_messages(message):
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    inputs_k = {
        "question": message.text
    }

    # –ó–∞–ø—É—Å–∫ —Ü–µ–ø–æ—á–∫–∏ —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
    response = chain_keys.invoke(inputs_k)


    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ retriever
    docs = retriever.get_relevant_documents(response.content)
    context = format_docs(docs)  # —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–≤–µ—Ç–∞, –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    inputs = {
        "context": context,
        "question": message.text
    }

    # –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏
    response = chain.invoke(inputs)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    bot.send_message(message.chat.id, response.content)


bot.polling(none_stop=True)
